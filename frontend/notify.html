<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>公众号通知 - 基金指数分析系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-6 space-y-6">
      <header class="border-b border-slate-800 pb-2 mb-4">
        <div class="flex items-center justify-between">
          <h1 class="text-xl sm:text-2xl font-bold tracking-tight">基金指数分析系统</h1>
          <nav class="flex rounded-full bg-slate-900/80 border border-slate-800 p-1 text-sm">
            <a href="/" class="px-3 sm:px-4 py-1.5 rounded-full font-medium text-slate-200 hover:bg-slate-800/80">指数分析</a>
            <a href="/static/sync.html" class="px-3 sm:px-4 py-1.5 rounded-full font-medium text-slate-200 hover:bg-slate-800/80">基础数据</a>
            <a href="/static/db.html" class="px-3 sm:px-4 py-1.5 rounded-full font-medium text-slate-200 hover:bg-slate-800/80">数据管理</a>
            <a href="/static/notify.html" class="px-3 sm:px-4 py-1.5 rounded-full font-medium bg-slate-100 text-slate-900 shadow-sm">公众号通知</a>
          </nav>
        </div>
      </header>

      <section id="main-section" class="space-y-4">
        <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-sm font-semibold text-slate-100">订阅者列表</h2>
            <div class="flex items-center gap-2">
              <button type="button" id="btn-select-all" class="text-xs text-slate-400 hover:text-slate-100">全选</button>
              <span class="text-slate-500">|</span>
              <button type="button" id="btn-select-none" class="text-xs text-slate-400 hover:text-slate-100">取消全选</button>
              <button type="button" id="btn-refresh" class="text-xs text-indigo-400 hover:text-indigo-300">刷新</button>
            </div>
          </div>
          <div id="subscribers-list" class="max-h-60 overflow-y-auto space-y-1.5 pr-1 text-sm">
            <p class="text-slate-500 text-xs">加载中…</p>
          </div>
          <p id="subscribers-summary" class="text-xs text-slate-400 mt-2"></p>
        </div>

        <div class="bg-slate-900/70 border border-slate-800 rounded-xl p-4">
          <h2 class="text-sm font-semibold text-slate-100 mb-2">发送自定义消息</h2>
          <p class="text-xs text-slate-400 mb-2">向选中的订阅者发送一条模板消息（需在 .env 中配置 WECHAT_TEMPLATE_ID_CUSTOM）。</p>
          <textarea id="custom-content" rows="4" class="w-full rounded-lg bg-slate-800 border border-slate-600 px-3 py-2 text-sm text-slate-100 placeholder-slate-500 resize-y" placeholder="输入要发送的消息内容（最多约 200 字）"></textarea>
          <div class="mt-3 flex items-center gap-3">
            <button type="button" id="btn-send" class="rounded-lg bg-emerald-600 text-white text-sm font-medium px-4 py-2 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed">发送</button>
            <span id="send-result" class="text-xs text-slate-400"></span>
          </div>
        </div>

      </section>

      <div id="toast-container" class="fixed inset-x-0 top-4 flex justify-center pointer-events-none z-50"></div>
    </div>

    <script>
      const apiBase = "";

      function showToast(message, type) {
        const container = document.getElementById("toast-container");
        const el = document.createElement("div");
        el.className = "pointer-events-auto rounded-md px-4 py-2 text-sm shadow-lg border " +
          (type === "error" ? "bg-red-900/90 border-red-600 text-red-100" :
           type === "success" ? "bg-emerald-900/90 border-emerald-600 text-emerald-100" :
           "bg-slate-900/90 border-slate-700 text-slate-100");
        el.textContent = message;
        container.appendChild(el);
        setTimeout(() => {
          el.classList.add("opacity-0", "translate-y-2");
          el.addEventListener("transitionend", () => el.remove(), { once: true });
        }, 2500);
      }

      async function apiFetch(path, options = {}) {
        const headers = { "Content-Type": "application/json", ...options.headers };
        const resp = await fetch(apiBase + path, { ...options, headers });
        if (!resp.ok) {
          let detail = "";
          try {
            const data = await resp.json();
            detail = typeof data.detail === "string" ? data.detail : JSON.stringify(data.detail || data);
          } catch (e) {
            detail = resp.statusText;
          }
          throw new Error(detail || "请求失败");
        }
        if (resp.status === 204) return null;
        try {
          return await resp.json();
        } catch (e) {
          return null;
        }
      }

      function renderSubscribers(list) {
        const el = document.getElementById("subscribers-list");
        const summary = document.getElementById("subscribers-summary");
        if (!list || list.length === 0) {
          el.innerHTML = "<p class=\"text-slate-500 text-xs\">暂无订阅者，或未配置公众号。</p>";
          summary.textContent = "0 人";
          return;
        }
        el.innerHTML = list.map((s, i) => {
          const label = (s.nickname ? s.nickname + " (" + s.openid.slice(0, 8) + "…)" : s.openid);
          return "<label class=\"flex items-center gap-2 cursor-pointer hover:bg-slate-800/50 rounded px-2 py-1\"><input type=\"checkbox\" class=\"subscriber-cb rounded border-slate-600\" data-openid=\"" + s.openid.replace(/"/g, "&quot;") + "\" /> <span class=\"text-slate-200 truncate\" title=\"" + (s.openid || "").replace(/"/g, "&quot;") + "\">" + (label || "").replace(/</g, "&lt;").replace(/>/g, "&gt;") + "</span></label>";
        }).join("");
        summary.textContent = "共 " + list.length + " 人，勾选上方订阅者后点击「发送」";
      }

      async function loadSubscribers() {
        const el = document.getElementById("subscribers-list");
        el.innerHTML = "<p class=\"text-slate-500 text-xs\">加载中…</p>";
        try {
          const list = await apiFetch("/admin/wechat/subscribers");
          renderSubscribers(list);
        } catch (e) {
          el.innerHTML = "<p class=\"text-red-400 text-xs\">" + (e.message || "加载失败") + "</p>";
        }
      }

      function getSelectedOpenids() {
        return Array.from(document.querySelectorAll(".subscriber-cb:checked")).map(cb => cb.dataset.openid);
      }

      document.getElementById("btn-select-all").addEventListener("click", () => {
        document.querySelectorAll(".subscriber-cb").forEach(cb => { cb.checked = true; });
      });
      document.getElementById("btn-select-none").addEventListener("click", () => {
        document.querySelectorAll(".subscriber-cb").forEach(cb => { cb.checked = false; });
      });
      document.getElementById("btn-refresh").addEventListener("click", loadSubscribers);

      document.getElementById("btn-send").addEventListener("click", async () => {
        const openids = getSelectedOpenids();
        const content = (document.getElementById("custom-content").value || "").trim();
        if (!openids.length) {
          showToast("请至少选择一个订阅者", "error");
          return;
        }
        if (!content) {
          showToast("请输入消息内容", "error");
          return;
        }
        const btn = document.getElementById("btn-send");
        const resultEl = document.getElementById("send-result");
        btn.disabled = true;
        resultEl.textContent = "发送中…";
        try {
          const res = await apiFetch("/admin/wechat/send_custom", {
            method: "POST",
            body: JSON.stringify({ openids, content }),
          });
          resultEl.textContent = "已发送 " + (res.sent || 0) + " 人，失败 " + (res.failed || 0) + " 人";
          showToast("发送完成：成功 " + res.sent + "，失败 " + res.failed, res.failed > 0 ? "info" : "success");
        } catch (e) {
          resultEl.textContent = "";
          showToast(e.message || "发送失败", "error");
        } finally {
          btn.disabled = false;
        }
      });

      loadSubscribers();
    </script>
  </body>
</html>
