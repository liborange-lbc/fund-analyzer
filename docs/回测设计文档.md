# 策略回测设计文档

## 背景与目标
- 为指数分析系统提供基础策略回测能力，覆盖定投、均值回归、趋势跟随三类常见策略
- 面向产品快速迭代：优先实现可解释的基础逻辑，后续可扩展手续费、滑点、仓位管理等

## 设计范围
- 数据来源：`index_prices` 表中的收盘价与已计算的均线字段
- 运行方式：后端接口按需计算，前端触发并展示回测结果
- 输出结果：资产净值曲线、交易记录、基础指标

## 策略定义
### 1) 定投（DCA）
- 初始资金在首个交易日一次性买入
- 根据频率（每日/每周/每月）追加固定金额并立即买入
- 不做卖出操作

### 2) 均值回归
- 使用单一均线周期 `MA` 作为参考
- 买入条件：`close <= MA * (1 - buy_threshold_pct)`
- 卖出条件：`close >= MA * (1 + sell_threshold_pct)`
- 全仓进出

### 3) 趋势跟随
- 使用单一均线周期 `MA`
- 买入条件：`close >= MA`
- 卖出条件：`close < MA`
- 全仓进出

## 数据与计算流程
1. 前端选择指数与策略参数
2. 调用 `/backtest` 接口
3. 后端读取 `index_prices`，按日期排序
4. 运行策略循环，生成：
   - 资产净值曲线（日期、现金、持仓、净值）
   - 交易记录（买入/卖出、价格、份额、原因）
5. 计算指标并返回结果

## 指标定义
- 总投入：初始资金 + 定投追加
- 期末净值：最后一个交易日的净值
- 总收益率：`(期末净值 - 总投入) / 总投入`
- 年化收益率：以首末日期日历天数换算
- 最大回撤：净值曲线的峰谷回撤

## 接口设计
### POST `/backtest`
请求体（示例）：
```
{
  "index_id": 1,
  "strategy": "mean_reversion",
  "initial_cash": 100000,
  "start_date": "2018-01-01",
  "end_date": "2023-12-31",
  "mean_reversion": {
    "ma_period": 60,
    "buy_threshold_pct": 3,
    "sell_threshold_pct": 3
  }
}
```

响应体（关键字段）：
```
{
  "index": { "id": 1, "code": "SPY", "name": "SPY", ... },
  "strategy": "mean_reversion",
  "params": { "ma_period": 60, "buy_threshold_pct": 3, "sell_threshold_pct": 3 },
  "metrics": { "total_return_pct": 12.3, "max_drawdown_pct": 8.6, ... },
  "equity_curve": [ { "trade_date": "2020-01-02", "value": 100000, ... } ],
  "trades": [ { "trade_date": "2020-01-02", "action": "buy", ... } ]
}
```

## 技术实现
- 新模块：`fund_analyzer/backtest.py`
- 接口：`fund_analyzer/main.py` 新增 `/backtest`
- Schema：`fund_analyzer/schemas.py` 增加回测请求/响应模型
- 前端：`frontend/index.html` 增加回测表单与净值曲线展示

## 限制与扩展方向
- 暂不包含手续费、滑点、分红复权
- 策略均为全仓进出，未实现仓位控制
- 可扩展：多均线交叉、止盈止损、组合回测、基准对比
