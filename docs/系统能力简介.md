# 基金指数分析系统 · 能力简介

## 一、系统概览

本系统用于**指数行情采集、存储与可视化分析**，支持多指数配置、历史数据拉取、均线/均值偏差计算，以及定时同步至今日。

```mermaid
flowchart LR
    subgraph 外部
        CS[中证指数官网\nCSIndex API]
    end
    subgraph 本系统
        API[FastAPI 服务]
        DB[(SQLite)]
        Sched[定时调度\n每5秒/每日]
        FE[前端\n指数分析·基础数据·数据管理]
    end
    CS -->|拉取行情| API
    API --> DB
    Sched --> API
    FE <-->|REST API| API
```

---

## 二、整体架构

```mermaid
flowchart TB
    subgraph 前端
        A[指数分析\nindex.html]
        B[基础数据\nsync.html]
        C[数据管理\ndb.html]
    end
    subgraph 后端
        M[main.py\n路由·鉴权]
        F[fetcher.py\n拉数·均线计算]
        S[scheduler.py\n同步至今日任务]
    end
    subgraph 存储
        DB[(fund_analyzer.db)]
    end
    A --> M
    B --> M
    C --> M
    M --> F
    M --> DB
    S --> F
    F --> DB
```

---

## 三、数据流

### 3.1 行情数据从采集到展示

```mermaid
sequenceDiagram
    participant CS as 中证官网
    participant API as 后端 API
    participant DB as 数据库
    participant FE as 前端

    Note over API,S: 定时任务 或 手动同步
    API->>CS: 请求指数历史 (indexCode, startDate, endDate)
    CS-->>API: JSON 行情列表
    API->>API: 计算涨跌幅、写入/更新
    API->>DB: 写入 index_prices
    Note over FE: 用户打开页面
    FE->>API: GET /indices/{id}/prices
    API->>DB: 查询
    DB-->>API: 行情记录
    API-->>FE: 收盘价、均线、偏差等
    FE->>FE: ECharts 绘图
```

### 3.2 均线与均值偏差的计算流程

```mermaid
flowchart LR
    A[原始行情\nclose, trade_date] --> B[计算均值\nMA 30/60/90/120/150/180/360]
    B --> C[写入 ma_* 字段]
    C --> D[计算均值偏差\nclose - ma_*]
    D --> E[写入 ma*_diff 字段]
    E --> F[前端展示/分析]
```

均线和偏差**不在拉数时自动算**，需在「基础数据」页对单指数或全部指数点击「计算均值」「计算均值偏差」触发。

### 3.3 美股指数（FRED + Alpha Vantage）

- **数据源（二选一或同时配置）**：
  - **[FRED](https://fred.stlouisfed.org/)**：配置 `FRED_API_KEY`（[免费申请](https://fred.stlouisfed.org/docs/api/api_key.html)），可拉取完整历史与最新价。
  - **[Alpha Vantage](https://www.alphavantage.co/)**：配置 `ALPHA_VANTAGE_API_KEY`（[免费申请](https://www.alphavantage.co/support/#api-key)），免费档约返回最近 100 个交易日；当 FRED 无数据时会自动尝试 Alpha Vantage。
- **支持的指数代码**：`NASDAQCOM`（纳斯达克综合）、`SP500`（标普500）、`DJIA`（道琼斯工业平均）。在「基础数据」中**新增指数**时，代码填上述之一即可拉取历史并参与定时同步。
- **接口**：`GET /us-indices/quote` 返回上述美股指数的最新净值，优先 FRED，无数据时用 Alpha Vantage。

---

## 四、功能模块总览

```mermaid
mindmap
  root(基金指数分析系统)
    指数分析
      指数趋势分析
        多指数选择
        收盘价走势
        多周期均线 30/60/90/120/150/180/360
      均值偏差趋势分析
        单指数
        收盘价 + 均线 + 偏差柱状
        负偏差统计与时间范围缩放
    基础数据
      指数配置
        新增/删除指数
        开始日期 start_date
      单指数操作
        计算均值
        计算均值偏差
      日历视图
        按年查看交易日
        点击某日查看当日均线与偏差
      手动同步
        同步全部历史
        同步今日
    数据管理
      表列表与行数据
      行级编辑
      审计日志
      同步任务日志
    定时任务
      同步至今日 每5秒
```

---

## 五、定时任务

```mermaid
flowchart TB
    subgraph 启动时
        S1[启动调度器]
        S2[立即执行 1 次同步至今日]
        S1 --> S2
    end
    subgraph 运行中
        J1[同步至今日\n每 5 秒]
        J1 --> L1[对每个指数：若最大日期不是今天\n则从缺漏日期拉到今天]
        L1 --> CS[中证 API]
    end
```

- **统一任务**：每 5 秒执行一次。对每个指数，若最大数据日期不是今天，则从「最大日期+1」或 start_date 开始拉取，直到更新到今天；已是今天则跳过。

---

## 六、核心数据模型（简化）

```mermaid
erDiagram
    indices ||--o{ index_prices : "has"
    indices {
        int id PK
        string code UK
        string name UK
        date start_date "可选"
    }
    index_prices {
        int id PK
        string index_code
        date trade_date
        float close
        float change_pct "涨跌幅"
        float pe_ratio "市盈率"
        float ma_30 .. ma_360
        float ma30_diff .. ma360_diff
    }
    sync_job_logs {
        string job_type
        string status
        datetime finished_at
    }
```

---

## 七、前端页面与入口

```mermaid
flowchart LR
    subgraph 页面
        P1["/ 或 /index.html\n指数分析"]
        P2["/static/sync.html\n基础数据"]
        P3["/static/db.html\n数据管理"]
    end
    P1 --> 趋势分析
    P1 --> 均值偏差分析
    P2 --> 指数卡片与日历
    P2 --> 计算均值/偏差
    P3 --> 表与审计
```

| 页面     | 路径               | 主要能力 |
|----------|--------------------|----------|
| 指数分析 | `/`                | 多指数趋势对比、均线开关；单指数均值偏差趋势与统计 |
| 基础数据 | `/static/sync.html`| 指数增删、开始日期、单/全量计算均线与偏差、日历视图、同步 |
| 数据管理 | `/static/db.html`  | 表浏览、行编辑、审计日志、同步任务日志 |

---

## 八、API 能力概览

```mermaid
flowchart TB
    subgraph 认证
        auth[POST /auth/login\nGET /auth/me\nPOST /auth/users]
    end
    subgraph 指数与行情
        idx[POST/GET/DELETE indices\nGET indices/id/prices\nGET indices/id/calendar/year]
        sync[POST indices/sync_all_history\nPOST indices/sync_today\nPOST indices/recalculate_ma*]
    end
    subgraph 管理
        admin[GET/PUT admin/tables/*\nGET admin/audit_logs\nGET admin/sync_logs]
    end
    auth --> idx
    idx --> sync
    sync --> admin
```

- **指数**：增删改查、按指数查行情、按年查日历数据。
- **同步与计算**：手动同步全部历史/今日、全部或单指数计算均值与均值偏差。
- **管理**：表数据、审计日志、同步任务日志（均支持分页等）。

---

## 九、技术栈简图

```mermaid
flowchart LR
    subgraph 前端
        HTML[HTML5]
        Tailwind[Tailwind CSS]
        ECharts[ECharts]
        Flatpickr[Flatpickr]
    end
    subgraph 后端
        FastAPI[FastAPI]
        SQLAlchemy[SQLAlchemy]
        APScheduler[APScheduler]
        Pydantic[Pydantic]
    end
    subgraph 数据
        SQLite[SQLite]
        CSIndex[中证指数 API]
    end
    HTML --> FastAPI
    FastAPI --> SQLAlchemy
    SQLAlchemy --> SQLite
    FastAPI --> CSIndex
    APScheduler --> FastAPI
```

---

以上为系统能力简介，**多用图**展示架构、数据流、功能分布、定时任务与数据模型，便于快速理解与对外说明。
