# 微信公众号通知配置说明

系统支持在**有新的数据更新**时，通过微信公众号模板消息通知所有订阅者。需使用**微信服务号**（订阅号不支持模板消息）。

---

## 一、需要您录入的公众号信息

在项目根目录的 `.env` 文件中增加以下变量（若不存在可新建）：

| 变量名 | 说明 | 获取路径（见下） |
|--------|------|------------------|
| `WECHAT_APPID` | 公众号 AppID | 开发 - 基本配置 |
| `WECHAT_APPSECRET` | 公众号 AppSecret | 开发 - 基本配置 |
| `WECHAT_TEMPLATE_ID_DATA_UPDATE` | 「新数据更新」使用的模板 ID | 功能 - 模板消息 |
| `WECHAT_TEMPLATE_ID_CUSTOM` | 「管理员自定义消息」使用的模板 ID（公众号通知页面向指定订阅者发消息） | 功能 - 模板消息 |
| `WECHAT_NOTIFY_DATA_UPDATE` | 是否默认开启「新数据更新」通知，可选：`true` / `false`（默认 `false`） | 无，直接写值 |

---

## 二、操作路径（在微信公众平台）

### 1. 获取 AppID、AppSecret

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 左侧菜单：**开发** → **基本配置**
3. **AppID**：在「开发者 ID(AppID)」一栏直接可见，复制到 `.env` 的 `WECHAT_APPID` 即可。

4. **AppSecret（开发者密码）**：和 AppID 在同一页的「开发者密码(AppSecret)」区域。
   - 若显示为「未启用」或只有「启用」按钮：先点击 **「启用」**，按提示用**管理员微信扫码**并完成验证，启用后会显示「重置」。
   - 若已启用但密码被隐藏：点击 **「重置」**：
     1. 用**管理员微信号扫码**确认；
     2. 输入**公众号登录密码**和**验证码**，点「下一步」；
     3. 页面会生成并显示**新的 AppSecret**（只显示一次），**立即复制**到 `.env` 的 `WECHAT_APPSECRET` 保存。
   - **注意**：重置后旧 AppSecret 立即失效；若之前配置过 IP 白名单，重置后通常仍需在该页的「IP 白名单」里配置服务器出口 IP（否则接口可能报错）。

### 2. 申请「新数据更新」默认模板并获取模板 ID

1. 左侧菜单：**功能** → **模板消息**（服务号才有；订阅号请先升级为服务号）
2. 在「模板库」中搜索并添加一条**默认推荐**模板，例如：
   - 搜索 **「服务状态通知」** 或 **「数据更新提醒」**；
   - 或搜索 **「状态通知」**，选择带「通知内容」「时间」等字段的模板。
3. 添加成功后，在「我的模板」中会看到该模板的 **模板 ID**（一长串字母数字）。
4. 将**模板 ID** 复制到项目根目录 **`.env`** 中的 `WECHAT_TEMPLATE_ID_DATA_UPDATE=` 后面（等号后直接粘贴，不要加引号）。

**本系统发送的模板内容约定**（申请模板时字段名可能略有差异，请选最接近的）：

- **first**：标题，如「基金指数数据更新提醒」
- **keyword1**：事件类型，固定为「新数据更新」
- **keyword2**：更新摘要，如「H20269(中证500)+10条；…，共 15 条」
- **keyword3**：发送时间
- **remark**：如「点击查看详情」

若您的模板字段名不同（如 keyword1 为「业务类型」），只要顺序/含义对应即可，系统按上述语义填充。

### 3. 可选：默认是否开启「新数据更新」通知

- 在 `.env` 中设置 `WECHAT_NOTIFY_DATA_UPDATE=true` 表示**默认开启**「新数据更新」通知。
- 不设或设为 `false` 表示默认关闭；之后可在**管理端**通过接口或管理页面开关。

---

## 三、管理「通知哪些信息」

- **接口**（需管理员登录）：
  - `GET /admin/notification_settings`：查看所有通知事件开关（当前仅有「新数据更新」）。
  - `PUT /admin/notification_settings/data_update`：开启/关闭「新数据更新」通知。  
    请求体示例：`{"enabled": true}` 或 `{"enabled": false}`。
- 未配置公众号（未填 AppID/AppSecret/模板 ID）时，接口仍可正常开关，但不会实际发微信消息；配置完整后，开关生效，有数据更新且该事件开启时会向**所有关注公众号的用户**发送模板消息。

---

## 四、事件说明

| 事件类型 event_type | 说明 | 触发时机 |
|---------------------|------|----------|
| `data_update`（新数据更新） | 定时同步任务拉取到新行情数据后推送 | 每 5 秒的「同步至今日」任务中，若有任意指数写入新数据，则触发一次通知（本轮更新指数与条数会写在模板 keyword2 中） |

---

## 五、.env 示例

```env
# 微信公众号（模板消息，服务号）
WECHAT_APPID=wxXXXXXXXXXXXXXXXX
WECHAT_APPSECRET=你的AppSecret
WECHAT_TEMPLATE_ID_DATA_UPDATE=模板ID
WECHAT_NOTIFY_DATA_UPDATE=false
```

修改 `.env` 后需**重启服务**生效；通知开关（开/关「新数据更新」）可通过 API 随时修改，无需重启。

---

## 六、公众号通知页面（指定订阅者发送自定义消息）

- **入口**：前端导航「公众号通知」或访问 `/static/notify.html`。
- **功能**：管理员登录后，可查看当前公众号订阅者列表（openid + 昵称），勾选要通知的用户，输入自定义消息内容后点击「发送」，即向所选订阅者发送一条模板消息。
- **依赖**：在 `.env` 中配置 **`WECHAT_TEMPLATE_ID_CUSTOM`**（在公众平台申请一条用于「管理员通知」的模板，建议包含：**first**、**keyword1**=内容、**keyword2**=时间）。未配置时发送会提示“未配置自定义消息模板 ID”。
